<!doctype html>
<html lang="en">
<head>
    <title>New Case Rates</title>
    <!--suppress JSUnresolvedLibraryURL -->
    <script type="text/javascript"
            src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {'packages': ['annotationchart']});
        state = {
            coldSeries: new Set([
                "China",
                "Hubei, China",
                "US Except NY",
                "New York, US",
                "Multnomah, Oregon, US",
                "Washington, Oregon, US",
                "San Francisco, California, US",
                "San Mateo, California, US",
                "Santa Clara, California, US",
                "Italy",
                "France",
                "Brazil",
                "Russia",
            ]),
        }
        setState = s => {
            if (typeof s === "function") {
                s = s(state);
            }
            state = {
                ...state,
                ...s,
            };
            render(state);
        }
        toggleSeries = label => {
            setState(s => {
                const coldSeries = new Set(s.coldSeries);
                if (coldSeries.has(label)) {
                    coldSeries.delete(label);
                } else {
                    coldSeries.add(label);
                }
                return {
                    coldSeries,
                };
            })
        }
        render = state => {
            google.charts.setOnLoadCallback(() => {
                setTimeout(() => {
                annChart.showDataColumns(state.headers.map((_, i) => i));
                annChart.hideDataColumns(state.headers
                    .map((h, i) => state.coldSeries.has(h) ? i : null)
                    .filter(it => it != null));
                });
            });
            drawPicker(state.headers, state.coldSeries);
        }
        fetch("./rates.txt")
            .then(r => r.text())
            .then(r => r.trim()
                .split("\n")
                .map(r => r.split("|")))
            .then(lines => {
                const headers = lines.shift()
                headers.shift(); // cull the date column
                setState({
                    headers,
                });
                google.charts.setOnLoadCallback(() =>
                    drawChart(headers, lines))
            });

        function drawChart(headers, lines) {
            const table = new google.visualization.DataTable();

            table.addColumn('date', "Date");

            headers
                .forEach(h => table.addColumn('number', h));

            table.addRows(lines
                .map(r => {
                    const [m, d] = r[0]
                        .split("/")
                        .map(p => parseInt(p, 10));
                    r = r.slice(1)
                        .map(parseFloat);
                    r.unshift(new Date(2020, m - 1, d));
                    return r;
                }));

            var options = {
                dateFormat: "MMM d",
                displayZoomButtons: false,
                displayAnnotations: false,
            };

            window.annChart = new google.visualization.AnnotationChart(
                document.getElementById('ann_chart'));
            annChart.draw(table, options);
            annChart.hideDataColumns(headers.slice(1).map((_, i) => i));
            window.addEventListener(
                "resize",
                () => annChart.draw(table, options),
            );
            annChart.setVisibleChartRange(new Date(2020, 3 - 1, 15));
        }

        function drawPicker(headers, coldSeries) {
            document.getElementById('picker').innerHTML = headers
                .map(h =>
                    '<label style="display:block">' +
                    '<input type="checkbox"' + (coldSeries.has(h) ? '' : ' checked') + ' value="' + h + '" onclick="toggleSeries(\'' + h + '\')" /> ' + h +
                    '</label>')
                .join("");
        }
    </script>
</head>
<body>
<h1>New Cases per Day per 100,000 Population (7-day Rolling Average)</h1>
<div id="picker"
     style="float:right;box-sizing:border-box;width:20%;padding:0 1em">
</div>
<div id="ann_chart" style="width:80%;height:80vh"></div>
</body>
</html>