<!doctype html>
<html lang="en">
<head>
    <title>New Case Rates</title>
    <!--suppress JSUnresolvedLibraryURL -->
    <script type="text/javascript"
            src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {'packages': ['annotationchart']});
        state = {}
        setState = s => {
            if (typeof s === "function") {
                s = s(state);
            }
            state = {
                ...state,
                ...s,
            };
            render(state);
        }
        toggleSeries = label => {
            setState(s => {
                const coldSeries = new Set(s.coldSeries);
                if (coldSeries.has(label)) {
                    coldSeries.delete(label);
                } else {
                    coldSeries.add(label);
                }
                return {
                    coldSeries,
                };
            })
        }
        render = state => {
            google.charts.setOnLoadCallback(() => {
                setTimeout(() => {
                annChart.showDataColumns(state.headers.map((_, i) => i));
                annChart.hideDataColumns(state.headers
                    .map((h, i) => state.coldSeries.has(h) ? i : null)
                    .filter(it => it != null));
                });
            });
            drawPicker(state.headers, state.coldSeries);
        }
        Promise.all([
            fetch("./rates.txt")
                .then(r => r.text())
                .then(r => r.trim()
                    .split("\n")
                    .map(r => r.split("|"))),
            fetch("../events.txt")
                .then(r => r.text())
                .then(r => r.trim()
                    .split("\n")
                    .map(r => r.split("|"))),
        ])
            .then(([lines, events]) => {
                const headers = lines.shift()
                headers.shift(); // cull the date column
                const hotSeries = new Set([
                    "Worldwide",
                    "US",
                    "Oregon, US",
                    "California, US",
                ])
                setState({
                    headers,
                    coldSeries: new Set(headers
                        .filter(it => !hotSeries.has(it)))
                });
                google.charts.setOnLoadCallback(() =>
                    drawChart(headers, lines, events))
            });

        function drawChart(headers, lines, events) {
            const table = new google.visualization.DataTable();
            // a single two-level index
            const byJnD = events.slice(1).reduce((agg, [dt, jur, evt, desc]) => {
                if (!agg.has(jur)) {
                    agg.set(jur, new Map());
                }
                const di = agg.get(jur);
                if (!di.get(dt)) {
                    di.set(dt, []);
                }
                di.get(dt).push(evt, desc);
                return agg;
            }, new Map());

            table.addColumn('date', "Date");

            headers
                .forEach(h => {
                    table.addColumn('number', h);
                    if (byJnD.has(h)) {
                        table.addColumn('string', 'Event');
                        table.addColumn('string', 'Description');
                    }
                });

            table.addRows(lines
                .map(r => {
                    const dt = r[0];
                    const [m, d] = dt
                        .split("/")
                        .map(p => parseInt(p, 10));
                    r = r.slice(1)
                        .flatMap((n, i) => {
                            const p = [parseFloat(n)]
                            const di = byJnD.get(headers[i]);
                            if (di != null) {
                                if (di.has(dt)) {
                                    const [evt, desc] = di.get(dt);
                                    p.push(evt);
                                    p.push(desc);
                                } else {
                                    p.push(null);
                                    p.push(null);
                                }
                            }
                            return p;
                        });
                    r.unshift(new Date(2020, m - 1, d));
                    return r;
                }));

            var options = {
                dateFormat: "MMM d",
                displayZoomButtons: false,
            };

            window.annChart = new google.visualization.AnnotationChart(
                document.getElementById('ann_chart'));
            annChart.draw(table, options);
            annChart.hideDataColumns(headers.slice(1).map((_, i) => i));
            window.addEventListener(
                "resize",
                () => annChart.draw(table, options),
            );
            annChart.setVisibleChartRange(new Date(2020, 3 - 1, 15));
        }

        function drawPicker(headers, coldSeries) {
            document.getElementById('picker').innerHTML = headers
                .map(h =>
                    '<label style="display:block">' +
                    '<input type="checkbox"' + (coldSeries.has(h) ? '' : ' checked') + ' value="' + h + '" onclick="toggleSeries(\'' + h + '\')" /> ' + h +
                    '</label>')
                .join("");
        }
    </script>
</head>
<body>
<h1>New Cases per Day per 100,000 Population (7-day Rolling Average)</h1>
<div id="picker"
     style="float:left;box-sizing:border-box;width:20%;padding:0 1em">
</div>
<div id="ann_chart" style="width:80%;padding-left:20%;height:80vh"></div>
<hr />
<p>COVID-19 and population data from
    <a href="https://github.com/CSSEGISandData/COVID-19">COVID-19 Data
    Repository</a> by the Center for Systems Science and Engineering (CSSE) at
    Johns Hopkins University.
</p>
<p>Event data from various media and government sources.
</p>
</body>
</html>